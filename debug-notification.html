<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Notification</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 14px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        .debug-info {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        
        .step {
            background: #e7f3ff;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 15px 0;
        }
        
        .error {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            padding: 15px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” é€šçŸ¥åŠŸèƒ½è°ƒè¯•</h1>
        
        <div class="step">
            <h3>è°ƒè¯•æ­¥éª¤ï¼š</h3>
            <ol>
                <li>æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· (F12)</li>
                <li>åˆ‡æ¢åˆ° Console æ ‡ç­¾</li>
                <li>ç‚¹å‡»ä¸‹é¢çš„æµ‹è¯•æŒ‰é’®</li>
                <li>æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºå’Œé€šçŸ¥</li>
            </ol>
        </div>
        
        <div>
            <h3>æµ‹è¯•æŒ‰é’®ï¼š</h3>
            <button onclick="testBasicNotification()">æµ‹è¯•åŸºç¡€é€šçŸ¥</button>
            <button onclick="testRateLimitDetection()">æµ‹è¯•Rate Limitæ£€æµ‹</button>
            <button onclick="testBackendSend()">æµ‹è¯•åç«¯å‘é€</button>
            <button onclick="checkPermissions()">æ£€æŸ¥æƒé™</button>
        </div>
        
        <div id="debug-output" class="debug-info">ç­‰å¾…æµ‹è¯•...</div>
        
        <div class="error">
            <h3>âš ï¸ å¦‚æœæ²¡æœ‰é€šçŸ¥æ˜¾ç¤ºï¼š</h3>
            <ul>
                <li>æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦å…è®¸é€šçŸ¥æƒé™</li>
                <li>æ£€æŸ¥æ‰©å±•æ˜¯å¦æ­£ç¡®åŠ è½½</li>
                <li>æŸ¥çœ‹æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯</li>
                <li>ç¡®è®¤manifest.jsonä¸­æœ‰notificationsæƒé™</li>
            </ul>
        </div>
    </div>

    <script>
        function log(message) {
            const output = document.getElementById('debug-output');
            const timestamp = new Date().toLocaleTimeString();
            output.textContent += `[${timestamp}] ${message}\n`;
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('debug-output').textContent = '';
        }
        
        // æµ‹è¯•åŸºç¡€é€šçŸ¥åŠŸèƒ½
        function testBasicNotification() {
            clearLog();
            log('ğŸ§ª å¼€å§‹æµ‹è¯•åŸºç¡€é€šçŸ¥åŠŸèƒ½...');
            
            // ç›´æ¥é€šè¿‡background scriptå‘é€æ¶ˆæ¯æµ‹è¯•é€šçŸ¥
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                chrome.runtime.sendMessage({
                    type: 'TEST_NOTIFICATION',
                    notificationType: 'test',
                    title: 'ğŸ§ª æµ‹è¯•é€šçŸ¥',
                    message: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•é€šçŸ¥ï¼Œç”¨äºéªŒè¯é€šçŸ¥åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œ'
                }, (response) => {
                    if (chrome.runtime.lastError) {
                        log('âŒ å‘é€æµ‹è¯•æ¶ˆæ¯å¤±è´¥: ' + chrome.runtime.lastError.message);
                    } else {
                        log('âœ… æµ‹è¯•æ¶ˆæ¯å·²å‘é€');
                        log('å“åº”: ' + JSON.stringify(response));
                    }
                });
            } else {
                log('âŒ Chromeæ‰©å±•APIä¸å¯ç”¨');
            }
        }
        
        // æµ‹è¯•Rate Limitæ£€æµ‹
        function testRateLimitDetection() {
            clearLog();
            log('ğŸš« å¼€å§‹æµ‹è¯•Rate Limitæ£€æµ‹...');
            
            const orgId = 'org_debug_test_' + Date.now();
            const resetAt = Math.floor(Date.now() / 1000) + 300;
            
            log(`ç»„ç»‡ID: ${orgId}`);
            log(`é‡ç½®æ—¶é—´: ${resetAt} (${new Date(resetAt * 1000).toLocaleString()})`);
            
            // è§¦å‘rate limitæ£€æµ‹äº‹ä»¶
            window.dispatchEvent(new CustomEvent('rateLimitDetected', {
                detail: {
                    url: `https://demo.fuclaude.com/api/organizations/${orgId}/completion`,
                    domain: 'demo.fuclaude.com',
                    resetAt: resetAt,
                    status: 429,
                    orgId: orgId,
                    apiType: 'debug-test',
                    timestamp: Date.now()
                }
            }));
            
            log('âœ… Rate Limitäº‹ä»¶å·²è§¦å‘');
            log('è¯·æŸ¥çœ‹æ˜¯å¦æœ‰é€šçŸ¥å¼¹å‡º');
        }
        
        // æµ‹è¯•åç«¯å‘é€
        function testBackendSend() {
            clearLog();
            log('ğŸ“¡ å¼€å§‹æµ‹è¯•åç«¯å‘é€...');
            
            // é¦–å…ˆæ£€æŸ¥åç«¯é…ç½®
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                chrome.runtime.sendMessage({
                    type: 'GET_BACKEND_CONFIG'
                }, (response) => {
                    if (response && response.config) {
                        log('åç«¯é…ç½®: ' + JSON.stringify(response.config, null, 2));
                        
                        if (response.config.enabled && response.config.url) {
                            log('âœ… åç«¯å·²é…ç½®ï¼Œå¼€å§‹æµ‹è¯•å‘é€...');
                            testRateLimitDetection(); // è§¦å‘å®Œæ•´æµç¨‹
                        } else {
                            log('âŒ åç«¯æœªé…ç½®æˆ–æœªå¯ç”¨');
                            log('è¯·åœ¨æ‰©å±•popupä¸­é…ç½®åç«¯åœ°å€');
                        }
                    } else {
                        log('âŒ æ— æ³•è·å–åç«¯é…ç½®');
                    }
                });
            }
        }
        
        // æ£€æŸ¥æƒé™
        function checkPermissions() {
            clearLog();
            log('ğŸ” æ£€æŸ¥æ‰©å±•æƒé™...');
            
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                // æ£€æŸ¥åŸºæœ¬API
                log('âœ… chrome.runtime å¯ç”¨');
                
                if (chrome.notifications) {
                    log('âœ… chrome.notifications API å¯ç”¨');
                    
                    // å°è¯•åˆ›å»ºä¸€ä¸ªæµ‹è¯•é€šçŸ¥
                    chrome.notifications.create('test-permission', {
                        type: 'basic',
                        iconUrl: 'icon48.png',
                        title: 'ğŸ” æƒé™æµ‹è¯•',
                        message: 'å¦‚æœä½ çœ‹åˆ°è¿™ä¸ªé€šçŸ¥ï¼Œè¯´æ˜æƒé™æ­£å¸¸'
                    }, (notificationId) => {
                        if (chrome.runtime.lastError) {
                            log('âŒ é€šçŸ¥åˆ›å»ºå¤±è´¥: ' + chrome.runtime.lastError.message);
                        } else {
                            log('âœ… é€šçŸ¥åˆ›å»ºæˆåŠŸ: ' + notificationId);
                        }
                    });
                } else {
                    log('âŒ chrome.notifications API ä¸å¯ç”¨');
                }
                
                if (chrome.storage) {
                    log('âœ… chrome.storage API å¯ç”¨');
                } else {
                    log('âŒ chrome.storage API ä¸å¯ç”¨');
                }
            } else {
                log('âŒ Chromeæ‰©å±•ç¯å¢ƒä¸å¯ç”¨');
                log('è¯·ç¡®ä¿åœ¨æ‰©å±•ç¯å¢ƒä¸­è¿è¡Œæ­¤é¡µé¢');
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.addEventListener('load', () => {
            log('ğŸ“„ è°ƒè¯•é¡µé¢å·²åŠ è½½');
            log('è¯·ç‚¹å‡»æµ‹è¯•æŒ‰é’®å¼€å§‹è°ƒè¯•');
            
            // æ£€æŸ¥æ˜¯å¦åœ¨æ‰©å±•ç¯å¢ƒä¸­
            if (typeof chrome === 'undefined') {
                log('âš ï¸ è­¦å‘Š: æœªæ£€æµ‹åˆ°Chromeæ‰©å±•API');
            }
        });
    </script>
</body>
</html>
